<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive Table UI</title>
  <style>
    :root {
      --color-cyan: #00ffff;
      --color-cyan-dark: #00bfbf;
      --color-ok: #00ffc8;
      --color-error: #ff4a4a;
      --color-processing: #0090b2;
      --bg-pitchblack: #111218;
      --bg-navbar: #15161e;
      --bg-advanced: #23242e;
      --text-cyan: #00ffff;
      --text-light: #f1f1f1;
      --highlight: #00ffff;
      --transition: 0.2s cubic-bezier(.4,0,.2,1);
      --border: #22232a;
      --shadow: 0 2px 20px rgba(0,255,255,0.04);
      --th-radius: 8px;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--bg-pitchblack);
      color: var(--text-light);
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      font-size: 16px;
      box-sizing: border-box;
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-navbar);
      color: var(--text-cyan);
      padding: 1em 2em;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: var(--shadow);
      border-bottom: 1px solid var(--border);
    }

    .status {
      padding: 0.3em 1em;
      border-radius: 14px;
      font-weight: 500;
      letter-spacing: 0.05em;
      margin-right: 0.6em;
      font-size: 0.95em;
      transition: var(--transition);
      background: var(--bg-pitchblack);
      color: var(--color-cyan);
      border: 1px solid var(--color-cyan-dark);
    }
    .status.ok {
      background: var(--color-ok);
      color: #111218;
      border-color: var(--color-ok);
    }
    .status.error {
      background: var(--color-error);
      color: #fff;
      border-color: var(--color-error);
    }
    .status.processing {
      background: var(--color-processing);
      color: #fff;
      border-color: var(--color-processing);
    }

    .navbar-actions {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }

    button {
      background: none;
      color: var(--color-cyan);
      border: 1.5px solid var(--color-cyan-dark);
      padding: 0.35em 1em;
      margin: 0;
      font-size: 1em;
      border-radius: 7px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, border 0.18s;
      outline: none;
      font-weight: 500;
      letter-spacing: 0.03em;
    }
    button:hover, button:focus-visible {
      background: var(--color-cyan-dark);
      color: #111218;
      border-color: var(--color-cyan);
    }

    #startBtn {
      background: var(--color-cyan);
      color: #1c222a;
      border: none;
      font-weight: 600;
      margin-left: 1em;
    }
    #startBtn:hover {
      background: #00e0e0;
      color: #101014;
    }

    /* Animated border for advanced menu */
    .advanced-menu {
      display: none;
      padding: 1em 2em;
      background: var(--bg-advanced);
      color: var(--text-cyan);
      position: relative;
      border-radius: 12px;
      animation: fadeIn 0.2s forwards;
      margin: 0 2em 1em 2em;
      border: 2px solid transparent;
      background-clip: padding-box;
      box-shadow: 0 0 0 0 var(--color-cyan);
    }
    .advanced-menu.animated-border {
      animation: borderGlow 1.2s linear infinite, fadeIn 0.2s forwards;
      border-image: linear-gradient(90deg, var(--color-cyan) 0%, var(--color-cyan-dark) 100%);
      border-image-slice: 1;
      box-shadow: 0 0 16px 2px var(--color-cyan-dark);
    }

    @keyframes borderGlow {
      0% {
        box-shadow: 0 0 8px 2px var(--color-cyan-dark), 0 0 0 0 var(--color-cyan-dark) inset;
        border-color: var(--color-cyan);
      }
      50% {
        box-shadow: 0 0 22px 6px var(--color-cyan), 0 0 0 0 var(--color-cyan-dark) inset;
        border-color: var(--color-cyan-dark);
      }
      100% {
        box-shadow: 0 0 8px 2px var(--color-cyan-dark), 0 0 0 0 var(--color-cyan-dark) inset;
        border-color: var(--color-cyan);
      }
    }

    .advanced-menu label {
      display: block;
      margin-bottom: 0.45em;
      font-size: 0.96em;
      color: var(--text-cyan);
    }
    .advanced-menu input, .advanced-menu select {
      background: #17191f;
      border: 1px solid var(--color-cyan-dark);
      color: var(--text-cyan);
      padding: 0.3em 0.7em;
      border-radius: 5px;
      font-size: 1em;
      margin-left: 0.4em;
      margin-top: 0.12em;
      margin-bottom: 0.12em;
      transition: border 0.18s;
    }
    .advanced-menu input:focus, .advanced-menu select:focus {
      border-color: var(--color-cyan);
      outline: none;
    }

    #table-container {
      overflow-x: auto;
      margin: 2em auto 1.5em auto;
      max-width: 96vw;
      min-height: 180px;
      border-radius: 16px;
      background: var(--bg-navbar);
      box-shadow: var(--shadow);
      border: 1.5px solid var(--border);
      padding-bottom: 0.3em;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: transparent;
      color: var(--text-cyan);
      font-size: 0.97em;
      letter-spacing: 0.01em;
      border-radius: var(--th-radius);
      overflow: hidden;
      transition: box-shadow 0.18s;
    }

    th, td {
      padding: 0.7em 1.1em;
      border-bottom: 1px solid #22242a;
      text-align: left;
      background: none;
      transition: background 0.16s;
    }

    th {
      background: #181a22;
      font-weight: 600;
      color: var(--color-cyan);
      position: relative;
      user-select: none;
      cursor: grab;
      border-top: 1px solid var(--color-cyan-dark);
    }

    th.dragging {
      opacity: 0.47;
      border: 2.5px dashed var(--color-cyan);
      cursor: grabbing;
    }

    th.drag-over {
      background: #20242a;
    }

    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      width: 9px;
      height: 100%;
      cursor: col-resize;
      z-index: 2;
      user-select: none;
      border-radius: 0 8px 8px 0;
      transition: background 0.12s;
    }
    .resize-handle:hover {
      background: var(--color-cyan-dark);
    }

    tr:last-child td {
      border-bottom: none;
    }

    td {
      background: transparent;
      color: var(--text-light);
      font-weight: 400;
    }

    .pagination {
      margin: 0.5em auto 2em auto;
      text-align: center;
      color: var(--text-cyan);
      font-size: 1em;
    }

    .pagination button {
      background: none;
      color: var(--color-cyan);
      border: 1px solid var(--color-cyan-dark);
      padding: 0.33em 1.1em;
      border-radius: 6px;
      margin: 0 0.5em;
      font-size: 0.96em;
    }
    .pagination button:hover, .pagination button:focus {
      background: var(--color-cyan-dark);
      color: #181a22;
      border-color: var(--color-cyan);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-6px);}
      to { opacity: 1; transform: translateY(0);}
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div>
      <span class="status ok" id="status">OK</span>
    </div>
    <div class="navbar-actions">
      <span>Task ID: <span id="task_id" style="color:var(--color-cyan);">N/A</span></span>
      <button id="startBtn">Start Process</button>
      <button id="downloadBtn" style="display:none;">Download</button>
      <button id="toggleAdvBtn" title="Show advanced">&#9881;</button>
    </div>
  </div>
  <div class="advanced-menu" id="advancedMenu">
    <label>Temp Dir: <input type="text" id="tempDirInput" /></label>
    <label>Normalization Type:
      <select id="normalizationTypeSelect">
        <option>Min-Max</option>
        <option>Z-Score</option>
      </select>
    </label>
    <label>Rate Limit: <input type="number" min="1" max="100" id="rateLimitInput" /></label>
  </div>
  <div id="table-container"></div>
  <div class="pagination">
    <button onclick="prevPage()">Prev</button>
    Page <span id="page">1</span>
    <button onclick="nextPage()">Next</button>
  </div>

  <script>
    // --- Configurable ---
    const pageSize = 25;
    let currentPage = 1;
    let data = [];
    let columns = [];
    let dragSrcIndex = null;
    let colWidths = {}; // store column widths
    let ws = null; // WebSocket object
    let currentTaskId = 'N/A'; // Stores the current task ID

    // Base URL for initial data fetch (from port 3001)
    const DATA_API_BASE_URL = 'http://127.0.0.1:3001/api'; 
    // Base URL for all other export-related API interactions (to port 8080 with /api/export prefix)
    const EXPORT_API_BASE_URL = 'http://127.0.0.1:8080/api/export'; 

    // --- Status Helper ---
    function setStatus(type, txt) {
      const s = document.getElementById("status");
      s.textContent = txt;
      s.className = "status " + type;
    }

    // --- Fetch Data ---
    async function fetchData() {
      setStatus('processing', 'Loading data...');
      try {
        // Fetch data from the DATA_API_BASE_URL and the '/data' endpoint
        const res = await fetch(`${DATA_API_BASE_URL}/data`);
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
            columns = Object.keys(data[0]);
        } else {
            columns = []; // Ensure columns is empty if no data
            setStatus('error', 'No data to display');
            return; // Exit if no data
        }
        setStatus('ok', 'OK');
        renderTable();
      } catch (error) {
        console.error("Error fetching data:", error);
        setStatus('error', 'Error fetching data');
        // Fallback to mock data if API fetch fails
        data = [
            { "id": 1, "name": "Alice", "age": 30, "city": "New York", "occupation": "Engineer" },
            { "id": 2, "name": "Bob", "age": 24, "city": "Los Angeles", "occupation": "Designer" },
            { "id": 3, "name": "Charlie", "age": 35, "city": "Chicago", "occupation": "Doctor" },
            { "id": 4, "name": "Diana", "age": 28, "city": "Houston", "occupation": "Artist" },
            { "id": 5, "name": "Eve", "age": 22, "city": "Phoenix", "occupation": "Student" },
            { "id": 6, "name": "Frank", "age": 40, "city": "Philadelphia", "occupation": "Manager" },
            { "id": 7, "name": "Grace", "age": 29, "city": "San Antonio", "occupation": "Analyst" },
            { "id": 8, "name": "Heidi", "age": 31, "city": "San Diego", "occupation": "Developer" },
            { "id": 9, "name": "Ivan", "age": 26, "city": "Dallas", "occupation": "Consultant" },
            { "id": 10, "name": "Judy", "age": 33, "city": "San Jose", "occupation": "Architect" },
            { "id": 11, "name": "Kyle", "age": 27, "city": "Austin", "occupation": "Scientist" },
            { "id": 12, "name": "Liam", "age": 38, "city": "Jacksonville", "occupation": "Accountant" },
            { "id": 13, "name": "Mia", "age": 23, "city": "Fort Worth", "occupation": "Writer" },
            { "id": 14, "name": "Noah", "age": 30, "city": "Columbus", "occupation": "Editor" },
            { "id": 15, "name": "Olivia", "age": 25, "city": "Charlotte", "occupation": "Researcher" },
            { "id": 16, "name": "Peter", "age": 32, "city": "San Francisco", "occupation": "Marketer" },
            { "id": 17, "name": "Quinn", "age": 29, "city": "Indianapolis", "occupation": "Recruiter" },
            { "id": 18, "name": "Rachel", "age": 34, "city": "Seattle", "occupation": "Librarian" },
            { "id": 19, "name": "Sam", "age": 27, "city": "Denver", "occupation": "Photographer" },
            { "id": 20, "name": "Tina", "age": 31, "city": "Washington", "occupation": "Nurse" },
            { "id": 21, "name": "Uma", "age": 26, "city": "Boston", "occupation": "Therapist" }, 
            { "id": 22, "name": "Victor", "age": 39, "city": "El Paso", "occupation": "Electrician" },
            { "id": 23, "name": "Wendy", "age": 24, "city": "Detroit", "occupation": "Mechanic" },
            { "id": 24, "name": "Xavier", "age": 30, "city": "Nashville", "occupation": "Plumber" },
            { "id": 25, "name": "Yara", "age": 28, "city": "Memphis", "occupation": "Chef" },
            { "id": 26, "name": "Zane", "age": 33, "city": "Portland", "occupation": "Pilot" },
            { "id": 27, "name": "Anna", "age": 22, "city": "Oklahoma City", "occupation": "Student" },
            { "id": 28, "name": "Ben", "age": 41, "city": "Las Vegas", "occupation": "Engineer" },
            { "id": 29, "name": "Chloe", "age": 29, "city": "Louisville", "occupation": "Designer" },
            { "id": 30, "name": "David", "age": 36, "city": "Baltimore", "occupation": "Doctor" }
        ];
        if (data.length > 0) {
            columns = Object.keys(data[0]); 
            setStatus('processing', 'Loaded with fallback data'); 
        } else {
            columns = [];
            setStatus('error', 'No fallback data');
        }
        renderTable();
      }
    }

    // --- Render Table ---
    function renderTable() {
      const container = document.getElementById("table-container");
      const start = (currentPage - 1) * pageSize;
      const pageData = data.slice(start, start + pageSize);

      if (!columns.length) {
        container.innerHTML = "<div style='padding:2em;text-align:center;color:var(--text-cyan);'>No data to display. Please ensure your data API is running.</div>";
        document.getElementById("page").textContent = currentPage; // Still show current page
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      columns.forEach((col, index) => {
        const th = document.createElement("th");
        th.textContent = col;
        th.setAttribute("draggable", true);

        // Set column width if resized
        if (colWidths[col]) {
          th.style.width = colWidths[col] + 'px';
        }

        // Store original column name and index as data attributes for API calls
        th.dataset.originalColumnName = col;
        th.dataset.originalColumnIndex = index;

        // --- Drag & Drop logic ---
        th.addEventListener("dragstart", (e) => {
          dragSrcIndex = index;
          e.dataTransfer.setData("text/plain", ""); // Required for Firefox
          th.classList.add('dragging');
        });
        th.addEventListener("dragover", (e) => {
          e.preventDefault();
          th.classList.add('drag-over');
        });
        th.addEventListener("dragleave", (e) => {
          th.classList.remove('drag-over');
        });
        th.addEventListener("drop", async (e) => {
          e.preventDefault();
          th.classList.remove('drag-over');
          document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
          if (dragSrcIndex !== null && dragSrcIndex !== index) {
            const movedColumnName = columns[dragSrcIndex]; // Get the name of the column being moved
            const moved = columns.splice(dragSrcIndex, 1)[0];
            columns.splice(index, 0, moved);
            renderTable(); // Re-render table with new column order

            // Send column reorder to API using EXPORT_API_BASE_URL
            await sendColumnChangeToAPI({
                name: movedColumnName, // The name of the column that was moved
                coloumn: dragSrcIndex,    // Its original index
                change_order: index  // Its new index
            });
            dragSrcIndex = null;
          }
        });
        th.addEventListener("dragend", (e) => {
          th.classList.remove('dragging');
          document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
          dragSrcIndex = null;
        });

        // --- Column Resize ---
        const handle = document.createElement('div');
        handle.className = 'resize-handle';
        handle.addEventListener('mousedown', function(e) {
          e.stopPropagation();
          startResize(e, th, col);
        });
        th.appendChild(handle);

        // --- Double-click to rename column ---
        th.title = "Double-click to rename";
        th.addEventListener('dblclick', function(e) {
          e.preventDefault();
          th.setAttribute("contenteditable", true);
          th.focus();
        });
        th.addEventListener('blur', async function(e) {
          let newName = th.textContent.trim();
          const originalCol = th.dataset.originalColumnName; // Get the original name from data attribute
          const originalIndex = +th.dataset.originalColumnIndex; // Get the original index from data attribute

          // Check if the new name is different, not empty, and not a duplicate of existing *display* names
          if (newName && newName !== originalCol && !columns.some((c, i) => c === newName && i !== originalIndex)) {
            // Update the columns array with the new name at its current logical position
            const currentLogicalIndex = columns.indexOf(originalCol); // Find current logical index
            if (currentLogicalIndex !== -1) {
                columns[currentLogicalIndex] = newName;
                th.dataset.originalColumnName = newName; // Update data attribute for future consistency
                // Update colWidths entry if needed (move width from old name to new name)
                if (colWidths[originalCol]) {
                    colWidths[newName] = colWidths[originalCol];
                    delete colWidths[originalCol];
                }
                renderTable(); // Re-render to reflect header change and potentially data if keys change
                // Send column rename to API using EXPORT_API_BASE_URL
                await sendColumnChangeToAPI({
                    name: originalCol, // Send original name as reference
                    new_name: newName, // Send new name
                    coloumn: originalIndex, // Original index
                    change_order: originalIndex // Same position, but name changed
                });
            }
          } else {
            th.textContent = originalCol; // revert to original name if invalid or duplicate
          }
          th.removeAttribute("contenteditable");
        });
        th.addEventListener('keydown', function(e) {
          if (e.key === "Enter") {
            e.preventDefault();
            th.blur();
          }
        });

        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      pageData.forEach(row => {
        const tr = document.createElement("tr");
        columns.forEach(col => {
          const td = document.createElement("td");
          // Use the 'col' from the reordered 'columns' array to access data
          td.textContent = row[col] !== undefined ? row[col] : "";
          // Set cell width to match header if resized
          if (colWidths[col]) {
            td.style.width = colWidths[col] + 'px';
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      container.innerHTML = "";
      container.appendChild(table);

      document.getElementById("page").textContent = currentPage;
    }

    // --- Column Resize Logic ---
    let resizingCol = null;
    let startX = 0;
    let startWidth = 0;

    function startResize(e, th, colName) {
      resizingCol = { th, colName };
      startX = e.clientX;
      startWidth = th.offsetWidth;
      document.body.style.cursor = 'col-resize';
      document.addEventListener('mousemove', resizeCol);
      document.addEventListener('mouseup', stopResize);
    }

    function resizeCol(e) {
      if (!resizingCol) return;
      let diff = e.clientX - startX;
      let newWidth = Math.max(48, startWidth + diff); // min width 48px
      colWidths[resizingCol.colName] = newWidth;
      // Re-render only the affected column's width to avoid full table redraw during drag
      resizingCol.th.style.width = newWidth + 'px';
      // If you want all cells of the column to resize live, you'd need to loop through them,
      // but that can be performance heavy. For now, we only update header live.
      // Full render on stopResize will apply to all.
    }

    function stopResize(e) {
      if (!resizingCol) return; // Prevent error if stopResize called without startResize
      resizingCol = null;
      document.body.style.cursor = '';
      document.removeEventListener('mousemove', resizeCol);
      document.removeEventListener('mouseup', stopResize);
      renderTable(); // Re-render table to apply final widths to all cells consistently
    }

    // --- Pagination ---
    function nextPage() {
      if ((currentPage * pageSize) < data.length) {
        currentPage++;
        renderTable();
      }
    }
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    }

    // --- API Interactions ---

    // Sends column changes (reorder or rename) to the FastAPI /input endpoint
    async function sendColumnChangeToAPI(inputData) {
        const queryParams = new URLSearchParams(inputData).toString();
        try {
            // Send to EXPORT_API_BASE_URL
            const response = await fetch(`${EXPORT_API_BASE_URL}/input?${queryParams}`);
            if (!response.ok) {
                throw new Error(`Failed to send column update: ${response.statusText}`);
            }
            const result = await response.json();
            console.log("Column update sent to API:", result);
            setStatus('processing', 'Column updated on server');
            setTimeout(() => {
                if (document.getElementById("status").textContent === "Column updated on server") {
                    setStatus('ok', 'OK');
                }
            }, 1500);
        } catch (error) {
            console.error("Error sending column update to API:", error);
            setStatus('error', 'Error updating column');
        }
    }

    // Initiates the processing on the FastAPI backend
    async function startProcessing() {
        setStatus('processing', 'Starting process...');
        document.getElementById('startBtn').disabled = true; // Disable button while processing
        document.getElementById('downloadBtn').style.display = 'none'; // Hide download button

        try {
            // Send to EXPORT_API_BASE_URL
            const response = await fetch(`${EXPORT_API_BASE_URL}/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) {
                throw new Error(`Failed to start process: ${response.statusText}`);
            }
            const result = await response.json();
            currentTaskId = result.task_id;
            document.getElementById('task_id').textContent = currentTaskId;
            console.log("Process started with Task ID:", currentTaskId);
            setupWebSocket(currentTaskId); // Establish WebSocket connection
        } catch (error) {
            console.error("Error starting process:", error);
            setStatus('error', 'Failed to start process');
            document.getElementById('startBtn').disabled = false; // Re-enable button on error
        }
    }

    // Sets up the WebSocket connection for real-time status updates
    function setupWebSocket(task_id) {
        if (ws) {
            ws.close(); // Close existing connection if any
        }
        // WebSocket URL uses EXPORT_API_BASE_URL's host and path, replacing http with ws
        const wsUrl = EXPORT_API_BASE_URL.replace('http://', 'ws://') + `/ws/${task_id}`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log(`WebSocket connected for task ${task_id}`);
            setStatus('processing', 'Connected to process');
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            console.log("WebSocket message:", message);
            if (message.status) {
                setStatus(message.status, message.message); // Use message.status and message.message directly
                if (message.status === "completed") { // Your FastAPI sends 'ok' for completed
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                    document.getElementById('downloadBtn').onclick = () => {
                        window.location.href = `${EXPORT_API_BASE_URL}/download/${currentTaskId}`; // Download link
                    };
                    document.getElementById('startBtn').disabled = false; 
                } else if (message.status === "error") { // Your FastAPI sends 'error' for failed
                    document.getElementById('startBtn').disabled = false; 
                }
            }
        };

        ws.onclose = () => {
            console.log(`WebSocket disconnected for task ${task_id}`);
            // Only update status if it was actively processing or connected, not if already in error/ok state
            if (document.getElementById("status").className.includes("processing")) { 
                setStatus('error', 'Disconnected from process'); 
            }
        };

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
            setStatus('error', 'WebSocket Error');
        };
    }

    // --- Toggle Advanced Menu ---
    function toggleAdvanced() {
      const menu = document.getElementById("advancedMenu");
      const toggleButton = document.getElementById("toggleAdvBtn");
      if (menu.style.display === "block") {
        menu.style.display = "none";
        menu.classList.remove("animated-border");
        toggleButton.style.background = "none";
      } else {
        menu.style.display = "block";
        menu.classList.add("animated-border");
        toggleButton.style.background = "var(--color-cyan-dark)"; // Highlight button when menu is open
      }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('startBtn').addEventListener('click', startProcessing); // Renamed from startTask
      document.getElementById('toggleAdvBtn').addEventListener('click', toggleAdvanced);
      fetchData(); // Initial data load
    });
  </script>
</body>
</html>

